<div id="data-userinfo" data-userinfo='<%= JSON.stringify(userInfo) %>'></div>
<div id="data-posts" data-posts='<%= JSON.stringify(posts) %>'></div>
<div class="userInfo" id="userInfo"></div>
<button id="editProfile" onclick="window.location.href='/profile/edit'">Edit Profile</button>
<div class="postsList" id="posts"></div>
<button class="pagination" id="previousPage" onclick="previousPage()">Previous Page</button>
<button class="pagination" id="nextPage" onclick="nextPage()">Next Page</button>
<p class="pagination" id="pagep">Current Page: </p>
<script>
    let l = 10;
    let p = 1;
    const id = parseInt("<%= id %>");
    if (!(document.cookie.split(';').map(element => element.trim()).includes("authStatus=true"))) {window.location.href = "/login"};
    const pagep = document.querySelector("#pagep");
    const showUserInfo = async (data) => {
        const userInfoDiv = document.querySelector("#userInfo");
        const userInfo = data;
        const displayName = document.createElement("p"); const username = document.createElement("p"); const description = document.createElement("p"); const datetime = document.createElement("p");
        displayName.classList.add("displayName"); username.classList.add("username"); description.classList.add("description"); datetime.classList.add("datetime");
        displayName.innerText = userInfo.display_name; username.innerText = "@" + userInfo.username; description.innerText = userInfo.description; datetime.innerText = "Joined: " + moment(userInfo.datetime).fromNow() + ` (${moment(userInfo.datetime).format('MMMM Do YYYY')})`;
        const elements = [displayName, username, description, datetime];
        elements.forEach(element => userInfoDiv.appendChild(element));
    };
    const getPosts = async (id, l = 10, p = 1) => {
        try {
            const response = await fetch(`/api/v1/posts?limit=${l}&page=${p}&user=${id}`);
            const posts = await response.json();
            if (posts.success) {return posts.data} else {throw "error"};
        } catch(err) {console.log(err)};
    };
    const showPosts = async (id, l = 10, p = 1, data) => {
        const postsDiv = document.querySelector("#posts");
        const posts = data ? data : await getPosts(id, l, p); //make func to, for each of the posts, append a child and fill its info using the array element.
        if (!posts) {return false};
        const nextButton = document.querySelector("#nextPage");
        if (posts.length < l) {nextButton.style.display = "none"} else {nextButton.style.display = "inline"};
        postsDiv.replaceChildren();
        posts
        .map(element => {
            let div = document.createElement("div");
            div.classList.add("post");
            let title = document.createElement("a"); let content = document.createElement("p"); let creator = document.createElement("a");
            title.classList.add("title"); content.classList.add("content"); creator.classList.add("creator");
            title.href = `/post/${element.id}`;
            creator.href = `/user/${element.poster_id}`;
            title.innerText = element.title;
            creator.innerText = "Creator: " + element.display_name;
            content.innerText = element.content.substring(0, 15) + `...`
            let elements = [document.createElement("hr"), title, document.createElement("br"), creator, document.createElement("br"), content, document.createElement("hr")]
            elements.forEach(element => {div.appendChild(element)});
            return div;
        })
        .forEach(element => {
            postsDiv.appendChild(element);
        });
    };
    const updatePageP = () => {
        pagep.innerText = "Current Page: " + p;
        if (p <= 1) {document.querySelector("#previousPage").style.display = "none";} else {document.querySelector("#previousPage").style.display = "inline";}
    };
    const nextPage = async () => {
        const result = await showPosts(id, 10, p + 1);
        if (result === false) {return false};
        p++;
        updatePageP();

    };
    const previousPage = async () => {
        if (p <= 1) {return false};
        p--;
        await showPosts(id, 10, p);
        updatePageP();
    };
    const main = async () => {
        const userInfo = JSON.parse(document.querySelector("#data-userinfo").dataset.userinfo);
        console.log(JSON.parse(document.querySelector("#data-posts").dataset.posts));
        showUserInfo(userInfo);
        showPosts(userInfo.id, l, p, JSON.parse(document.querySelector("#data-posts").dataset.posts));
        updatePageP();
    };
    main();
</script>